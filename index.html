<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>圓滿宮聖事報名</title>
  <link rel="icon" href="logo.png" />
  <style>
    body { font-family: sans-serif; margin: 0; background: #fff5f5; }
    .container { max-width: 420px; margin: auto; padding: 2rem; background: white; border-radius: 16px; box-shadow: 0 0 12px rgba(0,0,0,0.2); }
    h1 { text-align: center; color: #b40000; }
    label { display: block; margin-top: 1rem; font-weight: bold; }
    input, select { width: 100%; padding: 0.5rem; margin-top: 0.25rem; border: 1px solid #ccc; border-radius: 8px; }
    button { width: 100%; padding: 0.75rem; background: #b40000; color: white; border: none; border-radius: 8px; font-size: 1rem; margin-top: 1.5rem; }
    #remainingCount { color: #b40000; margin-top: 0.5rem; font-weight: bold; }
    img.logo { display: block; margin: auto; width: 120px; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <img src="logo.png" class="logo" alt="圓滿宮 Logo"/>
    <h1>圓滿宮聖事報名</h1>
    <p><strong>提醒：</strong>一人最多報名三個名額。</p>
    <label>辦事日期：</label>
    <select id="dateSelect">
      <option value="2025-07-12">2025-07-12（六）</option>
      <option value="2025-07-20">2025-07-20（日）</option>
    </select>
    <label>時段選擇：</label>
    <select id="timeSelect"></select>
    <label>姓名 / 暱稱：</label>
    <input id="nickname" placeholder="請輸入暱稱" />
    <label>事由：</label>
    <select id="reasonSelect">
      <option value="第一次問事">第一次問事</option>
      <option value="問事">問事</option>
      <option value="開單">開單</option>
    </select>
    <div id="remainingCount">尚餘名額：-- / 15</div>
    <button onclick="submitForm()">送出報名</button>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabaseUrl = "https://ygtffksgngkwpuxpfuez.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const dateSelect = document.getElementById('dateSelect');
    const timeSelect = document.getElementById('timeSelect');
    const remainingCount = document.getElementById('remainingCount');

    const times = [
      "09:00", "09:30", "10:00", "10:30", "11:00", "11:30",
      "13:00", "13:30", "14:00", "14:30", "15:00", "15:30",
      "16:00", "16:30", "17:00"
    ];

    async function updateTimeOptions() {
      const date = dateSelect.value;
      const { data, error } = await supabase
        .from("bookings")
        .select("time")
        .eq("date", date);

      const taken = data ? data.map(d => d.time) : [];

      timeSelect.innerHTML = "";
      times.forEach(time => {
        const disabled = taken.filter(t => t === time).length >= 15;
        const option = document.createElement("option");
        option.value = time;
        option.textContent = time;
        if (disabled) option.disabled = true;
        timeSelect.appendChild(option);
      });

      const total = data ? data.length : 0;
      remainingCount.textContent = `本日剩餘名額：${15 - total} / 15`;
    }

    async function submitForm() {
      const nickname = document.getElementById("nickname").value;
      const reason = document.getElementById("reasonSelect").value;
      const date = dateSelect.value;
      const time = timeSelect.value;

      if (!nickname || !time) return alert("請填寫完整欄位");

      const { error } = await supabase.from("bookings").insert([
        { nickname, reason, date, time }
      ]);
      if (error) return alert("發生錯誤，請稍後再試！");
      alert("報名成功，祝闔家平安！");
      updateTimeOptions();
    }

    dateSelect.addEventListener("change", updateTimeOptions);
    document.addEventListener("DOMContentLoaded", updateTimeOptions);
  </script>
</body>
</html>