
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>圓滿宮聖事報名</title>
  <link rel="icon" type="image/png" href="logo.png">
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background: #fff8f0; margin: 0; padding: 1rem; }
    .container { max-width: 480px; margin: auto; background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 0 10px rgba(0,0,0,0.15); }
    h1 { text-align: center; color: #b40000; margin-top: 0; }
    .logo { display: block; margin: auto; width: 100px; }
    label { display: block; margin-top: 1.5rem; font-weight: bold; }
    input, select { width: 100%; padding: 0.5rem; margin-top: 0.5rem; border-radius: 8px; border: 1px solid #ccc; }
    button { width: 100%; margin-top: 2rem; padding: 0.75rem; font-size: 1.1rem; background: #b40000; color: white; border: none; border-radius: 8px; }
    #remainingCount { margin-top: 0.5rem; color: #b40000; font-weight: bold; text-align: right; }
  </style>
</head>
<body>
  <div class="container">
    <img class="logo" src="logo.png" alt="logo" />
    <h1>圓滿宮聖事報名</h1>
    <label for="dateSelect">辦事日期</label>
    <select id="dateSelect">
      <option value="2025-07-12">2025/07/12（六）</option>
      <option value="2025-07-20">2025/07/20（日）</option>
    </select>
    <label for="timeSelect">時段</label>
    <select id="timeSelect"></select>
    <label for="nickname">姓名 / 暱稱</label>
    <input type="text" id="nickname" placeholder="請輸入姓名或暱稱" />
    <label for="reason">事由</label>
    <select id="reason">
      <option value="第一次問事">第一次問事</option>
      <option value="問事">問事</option>
      <option value="開單">開單</option>
    </select>
    <div id="remainingCount">尚餘名額：-- / 15</div>
    <button onclick="submitForm()">送出報名</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabase = supabase.createClient(
      "https://ygtffksgngkwpuxpfuez.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlndGZma3Nnbmdrd3B1eHBmdWV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNjgwMjIsImV4cCI6MjA2Njk0NDAyMn0.o25-6PeqngEQdGGFw5n0JRkn7tdxrJuNGPbzdvTATY8"
    );

    const dateSelect = document.getElementById('dateSelect');
    const timeSelect = document.getElementById('timeSelect');
    const remainingCount = document.getElementById('remainingCount');

    const times = [
      "09:00", "09:30", "10:00", "10:30", "11:00", "11:30",
      "13:00", "13:30", "14:00", "14:30", "15:00", "15:30",
      "16:00", "16:30", "17:00"
    ];

    async function updateTimeOptions() {
      const selectedDate = dateSelect.value;
      const { data, error } = await supabase
        .from('bookings')
        .select('*')
        .eq('date', selectedDate);

      if (error || !Array.isArray(data)) {
        console.error("資料讀取錯誤", error);
        timeSelect.innerHTML = "<option disabled>資料錯誤，請稍後重試</option>";
        remainingCount.textContent = "尚餘名額：-- / 15";
        return;
      }

      const total = data.length;
      if (total >= 15) {
        timeSelect.innerHTML = "<option disabled>本日已額滿</option>";
        remainingCount.textContent = `尚餘名額：0 / 15`;
        return;
      }

      remainingCount.textContent = `尚餘名額：${15 - total} / 15`;

      const counts = {};
      data.forEach(d => {
        counts[d.time] = (counts[d.time] || 0) + 1;
      });

      timeSelect.innerHTML = "";
      times.forEach(time => {
        const option = document.createElement("option");
        option.value = time;
        option.textContent = time;
        if (counts[time] >= 15) option.disabled = true;
        timeSelect.appendChild(option);
      });
    }

    async function submitForm() {
      const nickname = document.getElementById("nickname").value.trim();
      const reason = document.getElementById("reason").value;
      const date = dateSelect.value;
      const time = timeSelect.value;

      if (!nickname || !date || !time) return alert("請填寫所有欄位");

      const { data: userCount, error: userError } = await supabase
        .from('bookings')
        .select('*')
        .eq('nickname', nickname);

      if (userCount && userCount.length >= 3) {
        return alert("每人最多報名三個名額！");
      }

      const { error } = await supabase.from("bookings").insert([{ nickname, reason, date, time }]);
      if (error) return alert("送出失敗，請稍後再試");

      alert("報名成功！祝闔家平安");
      updateTimeOptions();
    }

    document.addEventListener("DOMContentLoaded", updateTimeOptions);
    dateSelect.addEventListener("change", updateTimeOptions);
  </script>
</body>
</html>
